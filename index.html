<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Page Content Updater</title>
    <style>
        /* Add some simple styling for readability */
        #submitButton:disabled {
            background-color: gray; /* Darken the button when disabled */
            cursor: not-allowed;
        }
        #processingMessage {
            display: none; /* Hidden by default */
            color: red;
        }
    </style>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            // Fetch and display the current content
            await fetchCurrentContent();

            // Add event listener for the submit button
            document.getElementById('submitButton').addEventListener('click', async () => {
                const newText = document.getElementById('newContent').value;
                const updateCode = document.getElementById('updateCode').value;
                const email = document.getElementById('email').value;

                if (!newText || !updateCode || !email) {
                    alert('Please fill in all fields.');
                    return;
                }

                // Disable button and show processing message
                disableButton();

                // Verify the code first
                const codeValid = await verifyCode(updateCode);
                if (!codeValid) {
                    alert('Invalid code. Please check your email for the correct code.');
                    enableButton();
                    return;
                }

                // If code is valid, submit the updated content
                await submitUpdate(newText, email);
                enableButton();
            });

            // Automatically format content in the modify window
            document.getElementById('newContent').addEventListener('input', autoFormatContent);
        });

        // Function to fetch the current content, last update time, and modifier's email
        async function fetchCurrentContent() {
            try {
                const response = await fetch('https://us-central1-pagecheck-d317c.cloudfunctions.net/getCurrentContent');
                const data = await response.json();

                // Display current content for context
                document.getElementById('currentContent').textContent = data.content;
                document.getElementById('lastUpdated').textContent = 'Last updated: ' + data.lastUpdated;
                document.getElementById('modifiedBy').textContent = 'Modified by: ' + data.modifiedBy;
            } catch (error) {
                console.error('Error fetching current content:', error);
                alert('Failed to fetch current content. Please try again later.');
            }
        }

        // Function to verify the update code
        async function verifyCode(code) {
            try {
                const response = await fetch('https://us-central1-pagecheck-d317c.cloudfunctions.net/verifyCode', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code })
                });

                const result = await response.json();
                return result.valid;
            } catch (error) {
                console.error('Error verifying code:', error);
                alert('Failed to verify code. Please try again later.');
                return false;
            }
        }

        // Function to submit the updated content
        async function submitUpdate(content, email) {
            try {
                const response = await fetch('https://us-central1-pagecheck-d317c.cloudfunctions.net/finalizeUpdate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content, email })
                });

                const result = await response.text();
                alert(result); // Show success message
                await fetchCurrentContent(); // Refresh the displayed content
            } catch (error) {
                console.error('Error finalizing update:', error);
                alert('Failed to finalize update. Please try again later.');
            }
        }

        // Function to automatically format URLs, emails, phone numbers, and page breaks
        function autoFormatContent() {
            const textarea = document.getElementById('newContent');
            let formattedText = textarea.value;

            // Convert URLs to clickable links
            formattedText = formattedText.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1">$1</a>');
            // Convert emails to mailto links
            formattedText = formattedText.replace(/([a-zA-Z0-9._-]+@[a-zA-Z0-9._-]+\.[a-zA-Z0-9._-]+)/gi, '<a href="mailto:$1">$1</a>');
            // Convert phone numbers to tel links
            formattedText = formattedText.replace(/(\+?[0-9][0-9()\-\s]+[0-9])/g, '<a href="tel:$1">$1</a>');
            // Convert '---' or '===' to <hr> for page breaks
            formattedText = formattedText.replace(/^(---|===)$/gm, '<hr>');

            // Update the textarea with formatted content
            textarea.value = formattedText;
        }

        // Disable button and show processing message
        function disableButton() {
            const button = document.getElementById('submitButton');
            button.disabled = true;
            button.textContent = 'Processing...';
            document.getElementById('processingMessage').style.display = 'block';
        }

        // Enable button and hide processing message
        function enableButton() {
            const button = document.getElementById('submitButton');
            button.disabled = false;
            button.textContent = 'Submit New Content';
            document.getElementById('processingMessage').style.display = 'none';
        }
    </script>
</head>
<body>
    <h1>Fact Sheet Updater</h1>

    <!-- Current Content Recapitulation -->
    <h2>Current Content</h2>
    <p id="currentContent">Loading current content...</p>
    <p id="lastUpdated">Last updated: Never</p>
    <p id="modifiedBy">Modified by: N/A</p>

    <!-- Modify Content Section -->
    <h2>Modify Content</h2>
    <textarea id="newContent" rows="8" cols="50" placeholder="Enter new content here..."></textarea><br><br>
    
    <label for="updateCode">Enter Update Code:</label>
    <input type="text" id="updateCode" placeholder="Enter the code you received via email" required><br><br>

    <label for="email">Your Email:</label>
    <input type="email" id="email" placeholder="Enter your email" required><br><br>

    <button id="submitButton">Submit New Content</button>
    <p id="processingMessage">Processing... Please wait.</p>

    <p id="updateStatus"></p>
</body>
</html>
